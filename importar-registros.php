<?php// Precisando de ajuda para desenvolver o seu sistema? acesse sistema-web-para.com.br e contrate uma assessoria...require_once('inc.verifica.php');require_once('inc.iconnect.php');require_once('inc.funcoes.php');if($_GET['tabela']){$_SESSION['tabela'] = strip_tags($_GET['tabela']);unset($_SESSION['campos']);$sql = 'SHOW COLUMNS FROM '.ai($a, $_SESSION['tabela']).'';$res = mysqli_query($a, $sql);while($c = mysqli_fetch_array($res)){$_SESSION['campos'][] = $c['Field'];}}if(!$_SESSION['permissao'][$_SESSION['tabela']]['importar'] || $_SESSION['subordinacoes']){header('Location: ./?sair=true');exit;}function formatacao_automatica($valor){$data = DateTime::createFromFormat('d/m/Y', $valor);if ($data) {$valor = $data->format('Y-m-d');}return $valor;}?><!doctype html><html><head><?php$ttitulo = 'Importar registros para "'.strip_tags($_SESSION['tabela']).'"';include('inc.head.php');?></head><body><?phpinclude('inc.menu.php');?><div class="jumbotron"><div class="container"><h1>Importar registros para "<?php echo strip_tags($_SESSION['tabela']); ?>"</h1><p>...</p></div></div><div class="container"><ol class="breadcrumb"><li><a href="inicial.php">Inicial</a></li><li class="active">Importar registros para "<?php echo strip_tags($_SESSION['tabela']); ?>"</li></ol><?phpif($_POST['importar'] == true){if($_POST['substituir'] == true){$sql = 'TRUNCATE TABLE '.ai($a, $_SESSION['tabela']);$res = log_mysqli_query($a, $sql);}$csv = explode(PHP_EOL, $_SESSION['csv']);for($x=1;$x<conta($csv);$x++){$csv[$x] = explode($_POST['separador'], $csv[$x]);unset($linhas);for($y=0;$y<conta($_SESSION['campos']);$y++){if(substr($_SESSION['campos'][$y], 0, 3) == 'id_' && str_replace($_POST['delimitador'], '', $csv[$x][$_POST[$_SESSION['campos'][$y]]])){$id = sql($a, 'SELECT id AS valor FROM '.ai($a, substr($_SESSION['campos'][$y], 3, 255)).' WHERE '.primeiro_campo_nativo($a, substr($_SESSION['campos'][$y], 3, 255)).' = \''.ai($a, str_replace($_POST['delimitador'], '', $csv[$x][$_POST[$_SESSION['campos'][$y]]])).'\'');if(!$id){$sql = 'INSERT INTO '.ai($a, substr($_SESSION['campos'][$y], 3, 255)).' SET '.primeiro_campo_nativo($a, substr($_SESSION['campos'][$y], 3, 255)).' = \''.ai($a, str_replace($_POST['delimitador'], '', $csv[$x][$_POST[$_SESSION['campos'][$y]]])).'\'';$res = log_mysqli_query($a, $sql);$id = mysqli_insert_id($a);}$linhas[] = $_SESSION['campos'][$y].' = \''.ai($a, $id).'\'';}else {$linhas[] = $_SESSION['campos'][$y].' = \''.ai($a, formatacao_automatica(str_replace($_POST['delimitador'], '', $csv[$x][$_POST[$_SESSION['campos'][$y]]]))).'\'';}}$sql = 'INSERT INTO '.ai($a, $_SESSION['tabela']).' SET '.implode(', ', $linhas);$res = log_mysqli_query($a, $sql);$registros++; }?><div class="alert alert-success" role="alert"><strong>Ok!</strong> <?php echo $registros ?> registros importados com sucesso!</div><?php}?><div class="row"><h2 style="margin:15px;">Importar registros para "<?php echo strip_tags($_SESSION['tabela']); ?>"</h2><?phpif(is_uploaded_file($_FILES['arquivo']['tmp_name'])){$_SESSION['csv'] = trim(utf8_encode(file_get_contents($_FILES['arquivo']['tmp_name'])));$csv = explode(PHP_EOL, $_SESSION['csv']);?><form action="importar-registros.php" method="post" enctype="multipart/form-data" name="form1" id="form1"><?phpfor($x=0;$x<1;$x++){$csv[$x] = explode($_POST['separador'], $csv[$x]);for($y=0;$y<conta($_SESSION['campos']);$y++){if($_SESSION['permissao'][$_SESSION['tabela']][$_SESSION['campos'][$y]]['importar']){?><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><div class="well"><label for="<?php echo $_SESSION['campos'][$y] ?>"><?php echo $_SESSION['campos'][$y] ?></label><select name="<?php echo $_SESSION['campos'][$y] ?>" id="<?php echo $_SESSION['campos'][$y] ?>" class="form-control"><option></option><?phpfor($z=0;$z<conta($csv[$x]);$z++){$valor = str_replace($_POST['delimitador'], '', $csv[$x][$z]);?><option value="<?php echo $z ?>"<?php if(prepara_nome($valor, '_') == $_SESSION['campos'][$y]){ ?> selected="selected"<?php } ?>><?php echo $valor ?></option><?php}?></select></div></div><?phpinclude('inc.modulos-assimetricos.php');}}}?><div style="clear:both"></div><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enviar</button></div><div style="clear:both"></div><input type="hidden" name="separador" value="<?php echo strip_tags($_POST['separador']); ?>"><input type="hidden" name="delimitador" value="<?php echo htmlentities(strip_tags($_POST['delimitador'])); ?>"><input type="hidden" name="substituir" value="<?php echo strip_tags($_POST['substituir']); ?>"><input type="hidden" name="importar" value="true"></form><?php}else {?><form action="importar-registros.php" method="post" enctype="multipart/form-data" name="form1" id="form1"><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><div class="well"><label for="arquivo">Arquivo .csv: <i class="fas fa-asterisk"></i></label><input type="file" required="required" name="arquivo" id="arquivo" class="form-control"/></div></div><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><div class="well"><label for="separador">Colunas separadas com <i class="fas fa-asterisk"></i></label><input type="text" required="required" name="separador" id="separador" class="form-control" value=";"></div></div><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><div class="well"><label for="delimitador">Colunas delimitadas por</label><input type="text" name="delimitador" id="delimitador" class="form-control" value="<?php echo htmlentities('"'); ?>"> </div></div><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><div class="well"><label style="display:block">Substituir dados da tabela por arquivo: </label><input type="checkbox" name="substituir" id="substituir" value="true"> <label for="substituir" style="font-weight:normal; margin-right:10px;">Excluir registros atuais</label></div></div> <div style="clear:both"></div><div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 bloco"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enviar</button></div><div style="clear:both"></div></form><?php}?></div><?php include('inc.rodape.php'); ?></div></body></html>